<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content = 'IE=edge'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ProjectAIVA</title>
    <link href = "/static/css/me.css?detail=12" rel = 'stylesheet'/>
    <link href = "/static/css/bootstrap.css?detail=2" rel = 'stylesheet'/>
    <link rel="stylesheet" href="/static/css/bootstrap-select.css?q=1280549780">
    <link rel="stylesheet" href="/static/css/bootstrap-datepicker3.css?q=1280549780">
    <script type = "text/javascript" src = "/static/js/jquery-3.1.0.js?q=1280549780"></script>
    <script type = "text/javascript" src = "/static/js/bootstrap.js?q=1280549780"></script>
    <script type = "text/javascript" src = "/static/js/bootstrap-datepicker.js?q=1280549780"></script>
    <script src="/static/js/bootstrap-select.js"></script>
  </head>
  <body>
    {% include 'hola_ads/head.htm' %}

    <div id= 'top'>
      <div id = 'select_area'>
        <select class="selectpicker"  id = 'adtype_selector' data-size="20" title = "Type" onchange = 'refresh()'>
        </select>
        <select class="selectpicker" id = 'geo_selector' data-live-search="true" data-size="10" title = " Country" onchange = 'refresh()'>
        </select>
        Date: 
          <input class = 'me_date_picker' id = 'start_datepicker' type="text" class="form-control" value = "{{dt_start}}" onchange="refresh();">
          TO
          <input class = 'me_date_picker' id = 'end_datepicker' type="text" class="form-control" value = "{{dt_end}}" onchange="refresh();">
        Package: <input id = 'package_name_selector' value = '{{package_name}}' onchange = 'refresh()'/>
      </div>

      <div id = 'select_input'>
        搜索条件: 
        <span  class = "query_tag" value = "{{adtype}}" id = 'adtype_input' onclick = "tag_remove(this);">{{adtype}}</span>
        <span  class = "query_tag" value = "{{geo}}" id = 'geo_input' onclick = "tag_remove(this);">{{geo}}</span>
        <span  class = "query_tag" value = "{{package_name}}" id = 'package_name_input' onclick = "tag_remove(this);">{{package_name}}</span>
        <span  class = "query_tag" value = "{{dt_start}}" id = 'dt_start_input' onclick = "tag_remove(this);">{{dt_start}}</span>
        <span  class = "query_tag" value = "{{dt_end}}" id = 'dt_end_input' onclick = "tag_remove(this);">{{dt_end}}</span>
        <button type="button" id = 'query_button' class="btn btn-primary btn-g" data-toggle="modal">
          Query
        </button>
        <button type="button" id = 'clear_button'  style = "display: none;" class="btn btn-danger btn-g" data-toggle="modal">
          Clear
        </button>
      </div>
    </div>
    <div id = 'ads_detail'>
      <table id = 'ads_detail_table'>
        
      </table>
    </div>
    <div id = 'ads_table'></div>
    <div id="ads_page"
        style="position: fixed; bottom: 1%; z-index: 9998; right: 20%; display: ;">
      <ul class="pagination">
              <li><a href="javascript:prev();">&lt;&lt;</a></li>
              <li><a id="current_page">1</a></li>
              <li><a href="javascript:next();">&gt;&gt;</a></li>
              <li>&nbsp;</li>
              <li class="dropup">
                <select id = 'ads_page_selector' class="selectpicker" data-style="btn-info"
                      data-width="80px" data-size="5" data-title="跳页"
                      onChange="changepage_via_select()">
                  <option>#</option>
                </select>
              </li>
      </ul>
    </div>

    {% include 'hola_ads/foot.htm' %}

  </body>
  <script type="text/javascript">
    function get_selector(){
      $.ajax({
      url : "/pyanalyst/pyquery",
      method : 'post',
      data : {
        'typical' : 'get_selector'
      },
      dataType : 'json',
      success : function(data){
        export_to_dropdown(data);
      },
      error : function(err){
        alert(err);
      }
    });
    }
    function export_to_dropdown(data){
      var results = eval(data);
      var adtype_results = eval(results[0]);
      var geo_results = eval(results[1]);
      var adtype_results_str = ''
      for(var index in adtype_results){
        adtype_results_str += '<option>' + adtype_results[index][0] + '</option>';
      }
      $('#adtype_selector').html(adtype_results_str);
      var geo_results_str = '';
      for(var index in geo_results){
        geo_results_str += '<option>' + geo_results[index][0] + '</option>';
      }
      $('#geo_selector').html(geo_results_str);
      $('#adtype_selector').selectpicker('refresh');
      $('#geo_selector').selectpicker('refresh');
    }
    document.getElementById('query_button').onclick = function(){
      var href_str = '/pyanalyst?doquery=hai';
      var adtype = $('#adtype_input').attr('value')
      var geo = $('#geo_input').attr('value')
      var dt_start = $('#dt_start_input').attr('value')
      var dt_end = $('#dt_end_input').attr('value')
      var package_name = $('#package_name_input').attr('value')
      var page = ''
      var offset = '10'
      href_str += '&adtype=' + adtype + '&package_name=' + package_name + '&geo=' + geo + '&dt_start=' + dt_start
      + '&dt_end=' + dt_end + '&page=' + page + '&offset=' + offset
      window.location.href = href_str;
    }

    function refresh(){
      if($('#adtype_selector').val() != ''){
        $('#adtype_input').attr('value', $('#adtype_selector').val())
        $('#adtype_input').css('display', 'inline')
        $('#adtype_input').html($('#adtype_selector').val())
      }

      if($('#geo_selector').val() != ''){
        $('#geo_input').attr('value', $('#geo_selector').val())
        $('#geo_input').css('display', 'inline')
        $('#geo_input').html($('#geo_selector').val())
      }

      if($('#package_name_selector').val() != ''){
        $('#package_name_input').attr('value', $('#package_name_selector').val())
        $('#package_name_input').css('display', 'inline')
        $('#package_name_input').html($('#package_name_selector').val())
      }

      if($('#start_datepicker').val() != ''){
        $('#dt_start_input').attr('value', $('#start_datepicker').val())
        $('#dt_start_input').css('display', 'inline')
        $('#dt_start_input').html($('#start_datepicker').val())

      }

      if($('#end_datepicker').val() != ''){
        $('#dt_end_input').attr('value', $('#end_datepicker').val())
        $('#dt_end_input').css('display', 'inline')
        $('#dt_end_input').html($('#end_datepicker').val())
      }
    }

    function exprot_data_to_ad_list(data){
      var ads = eval(data);
      $('#ads_table').html('');
      var page_cell = ''
      for(var index in ads){
        var cell = '<div class = "ad_cell">'
        + '<div class = "ad_cell_head">'
        + '<table>'
        + '<tr>'
        + '<td rowspan = "2"><img class = "ad_cell_icon" src = "' + ads[index][5] + '"></td>'
        + '<td><p class = "ad_cell_title">' + decodeURIComponent(ads[index][8]).replace(/\+/g, ' ').substring(0, 40) + '</p></td>'
        + '</tr>'
        + '<tr>'
        + '<td><p class = "ad_cell_date">' + ads[index][15] + '</p></td>'
        + '</tr>'
        + '</table>'
        + '</div>'
        + '<div class = "ad_cell_body">'
        + '<table>'
        + '<tr><p class = "ad_cell_content">' + decodeURIComponent(ads[index][11]).replace(/\+/g, ' ') + '</p></tr>'
        + '<tr><img class = "ad_cell_image" src = "' + ads[index][20] + '"/></tr>'
        + '</table>'
        + '</div>'
        + '<div class = "ad_cell_feet">'
        + '<table>'
        + '<tr>'
        + '<td class = "ad_cell_social">' + decodeURIComponent(ads[index][7]).replace(/\+/g, ' ') + '</td>'
        + '<td class = "ad_cell_button"><button>' + decodeURIComponent(ads[index][9]).replace(/\+/g, ' ') + '</button></td>'
        + '</tr>'
        + '</table>'
        + '</div>'
        + '<div class = "ad_cell_tail">'
        + '<table>'
        + '<tr>'
        + '<td class = "ad_cell_duration"><img src = "static/pic/Duration.png"/> ' + ads[index][17] + 'd</td>'
        + '<td class = "ad_cell_heat"><img src = "static/pic/heat.png"/> ' + ads[index][18] + '</td>'
        + '<td class = "ad_cell_geo">' + ads[index][16] + '</td>'
        + '<td class = "ad_cell_category">' + ads[index][19] + '</td>'
        + '</tr>'
        + '<tr>'
        + '<td colspan = "4" class = "ad_cell_pkg">Pkg: <a href = "javascript:query_via_package(\'' + ads[index][14] + '\');">' + ads[index][14] + '</a></td>'
        + '</tr>'
        + '</table>'
        + '<table class = "ad_cell_buttons">'
        + '<tr>'
        + '<td>' + '<a target = "_blank" href = "' + ads[index][20] + '"><input class = "img_button" type = "button" value = "查看图片"/></a>' + '</td>'
        + '<td>' + '<a target = "_blank" href = "' + ads[index][6] + '&w=1200&h=627' + '"><input class = "img_button" type = "button" value = "查看大图"/></a>' + '</td>'
        + '<td>' + '<a  download = "projectAIVA" href = "' + ads[index][20] + '"><input class = "img_button" type = "button" value = "下载图片"/></a>' + '</td>'
        + '</tr>'
        + '</table>'
        + '</div>'
        + '</div>'
        page_cell += cell
      }
      $('#ads_table').html(page_cell)
    }

    function page_plugin_init(data){
      $.ajax({
        url : "/pyanalyst/pyquery",
        method : 'post',
        data : {
          'typical' : 'query_page_via_type_geo_date',
          'adtype' : $('#adtype_input').val(),
          'geo' : $('#geo_input').val(),
          'dt_start' : $('#dt_start_input').val(),
          'dt_end' : $('#dt_end_input').val(),
          'package_name' : $('#package_name_input').val(),
          'offset' : 10
        },
        dataType : 'json',
        success : function(data){
          var count = eval(data)[0][0];
          //refresh plugin
          var selector = $('#ads_page_selector')
          var options_str = ''
          for(var i = Math.ceil(count / 10); i > 0; i --){
            options_str +=
            '<option>' + i + '</option>'
          }
          selector.html(options_str)
          selector.selectpicker('refresh')
        },
        error : function(err){
          alert(err);
        }
      });
      var page = '{{page}}'
      try{
        page = parseInt(page)
      }catch(exception){
        $('#current_page').html('1')
        return
      }
      if(page > -1){
        $('#current_page').html(page)
        return
      }
      $('#current_page').html('1')
    }

    function changepage_via_select(){
      var page = $('#ads_page_selector').val()
      changepage(page)
    }

    function prev(){
      var current_page = $('#current_page').html()
      try{
        current_page = parseInt(current_page)
      }catch(exception){
        return
      }
      if(current_page <= 1){
        return
      }
      changepage(current_page - 1)
    }

    function next(){
      var current_page = $('#current_page').html()
      try{
        current_page = parseInt(current_page)
      }catch(exception){
        return
      }
      changepage(current_page + 1)
    }

    function changepage(page){
      var href_str = '/pyanalyst?doquery=hai';
      var adtype = $('#adtype_input').val()
      var geo = $('#geo_input').val()
      var dt_start = $('#dt_start_input').val()
      var dt_end = $('#dt_end_input').val()
      var package_name = $('#package_name_input').val()
      var page = page + ''
      var offset = '10'
      href_str += '&adtype=' + adtype + '&geo=' + geo + '&package_name=' + package_name + '&dt_start='
      + dt_start + '&dt_end=' + dt_end + '&page=' + page + '&offset=' + offset
      window.location.href = href_str
    }

    function query_via_package(pkg){
      var href_str = '/pyanalyst?doquery=hai';
      href_str += '&package_name=' + pkg
      window.location.href = href_str
    }

    function init_datepicker(){
      $('#start_datepicker').datepicker({
        format: 'yyyymmdd',
        clearBtn: true,
        todayHighlight: true,
        endDate: '0d',
      })
      $('#start_datepicker').datepicker().on('changeDate', function(e){
        $('#start_datepicker').datepicker('hide')
      })
      $('#end_datepicker').datepicker({
        format: 'yyyymmdd',
        clearBtn: true,
        todayHighlight: true,
        endDate: '0d',
      })
      $('#end_datepicker').datepicker().on('changeDate', function(e){
        $('#end_datepicker').datepicker('hide')
      })
    }
    document.getElementById('clear_button').onclick = function(){
      clear()
    }

    function clear(){
      $('#adtype_selector').selectpicker('val', '')
      $('#geo_selector').selectpicker('val', '')
      $('#adtype_selector').selectpicker('refresh');
      $('#geo_selector').selectpicker('refresh');
      $('#package_name_selector').val('')
      $('#start_datepicker').val('')
      $('#end_datepicker').val('')
      refresh()
    }

    function tag_remove(element){
      switch(element.id){
        case "adtype_input":{
          $('#' + element.id).css('display', 'none')
          $('#' + element.id).attr('value', '')
          break
        }
        case "geo_input":{
          $('#' + element.id).css('display', 'none')
          $('#' + element.id).attr('value', '')
          break
        }
        case "package_name_input":{
          $('#' + element.id).css('display', 'none')
          $('#' + element.id).attr('value', '')
          break
        }
        case "dt_start_input":{
          $('#' + element.id).css('display', 'none')
          $('#' + element.id).attr('value', '')
          break
        }
        case "dt_end_input":{
          $('#' + element.id).css('display', 'none')
          $('#' + element.id).attr('value', '')
          break
        }
        default:{

        }
      }
    }

    function init_tag(){
      var type_tag = "{{adtype}}"
      if (type_tag == ""){
        $('#adtype_input').css('display', 'none')
      }else{
        $('#adtype_input').css('display', 'inline')
      }
      var geo_tag = "{{geo}}"
      if (geo_tag == ""){
        $('#geo_input').css('display', 'none')
      }else{
        $('#geo_input').css('display', 'inline')
      }
      var package_name_tag = "{{package_name}}"
      if (package_name_tag == ""){
        $('#package_name_input').css('display', 'none')
      }else{
        $('#package_name_input').css('display', 'inline')
      }
      var dt_start_tag = "{{dt_start}}"
      if (dt_start_tag == ""){
        $('#dt_start_input').css('display', 'none')
      }else{
        $('#dt_start_input').css('display', 'inline')
      }
      var dt_end_tag = "{{dt_end}}"
      if (dt_end_tag == ""){
        $('#dt_end_input').css('display', 'none')
      }else{
        $('#dt_end_input').css('display', 'inline')
      }
    }


    window.onload = function (){
      console.log('query time: ' + ' {{query_time}} ')
      data = {{ data|tojson }}
      if(data != null && data != '' && data != '1'){
        exprot_data_to_ad_list(data)
      }
      init_datepicker()
      page_plugin_init()
      get_selector()
      init_tag()
    }
  </script>
  <style type="text/css">
    body{
      background: #f2f2f2;
    }
    #top{
      position: sticky;
      background: #f2f2f2;
      box-shadow: 0px 1px 1px #000000;
      width: 100%;
      top: 0px;
    }
    .query_tag{
      border: 1px solid #f2f2f2;
      border-radius: 3px;
      padding: 5px;
      margin: 3px;
      cursor: pointer;
      background: #00CCFF;
      color: #222222;
      font-size: 12px;
      display: none;
    }

    #select_area {
      padding: 10px;
      display: ;
    }
    #select_input{
      padding: 10px;
      display: ;
      text-align: center;
    }
    #nav {
      visibility: ;
    }
    #query_button{
      margin: 5px
    }
    #float_table{
      width: 50%;
      float: right;
      margin-right: 30px;
    }
    #float_table_table{
      border: 1px solid;
      text-align: center;
    }
    #float_table_table td{
      border: 1px solid;
      padding: 10px
    }
    #ads_detail{
      width:  60%;
      float: right;
      margin-right: 30px;
    }
    #ads_detail_table {
      border: 1px solid;
      text-align: center;
    }
    #ads_detail_table tr{
      display: block; 
      float: left;
      padding: 1px;
    }
    #ads_detail_table th, #ads_detail_table td {
      display: block; 
      border: 1px solid;
      padding: 1px
    }
    .ads_row{
      background: ;
      text-align: center;
      border: 10px groove #CCCCFF;
      display: inline-block;
      width: 100%;
    }
    .ads_content{
      float: left;
      font-size: 15px;
      margin: 5px;
    }
    .ads_content tr{
      border-bottom: 1px groove;
    }
    .ads_content td{
      padding: 4px;
    }

    .ads_content table td{
    }

    .icon_image{
      float: left;
      width: 150px;
      height: 150px;
    }
    .ad_image{
      float: right;
      width: 300px;
      height: 150px;
    }
    .package_info{
      cursor: pointer;
      color: blue;
    }

    #ads_page{
      position: fixed; 
      bottom: 1%; 
      z-index: 9998; 
      right: 20%; 
      display: 
    }
    #ads_page select{

    }
    .me_date_picker{
      width: 96px;
    }

    #ads_table{
    }

    /* page cell css */
    .ad_cell{
    background: #FAFAFA;
    width: 360px;
    padding: 10px;
    box-shadow: 0px 2px 2px #888888;
    font-family: Serif;
    margin: 10px;
    height: 430px;
    float: left;
    }
    .ad_cell_head{
      height: 60px;
    }
    .ad_cell_icon{
      width: 48px;
      height: 48px;
      margin-right: 20px;
    }
    .ad_cell_title{
      font-size: 12px;
      line-height: 20px;
    }
    .ad_cell_date{
      font-size: 12px;
    }
    .ad_cell_body{

    }
    .ad_cell_content{
      font-size: 12px;
      width: 340px;
      height: 36px;
    }
    .ad_cell_image{
      width: 340px;
      height: 178px;
    }
    .ad_cell_feet{
      box-shadow: 0px 1px 1px #888888;
      width: 340px;
      margin-top: 5px;
      padding-top: 5px;
      padding-bottom: 5px;
      margin-bottom: 5px;
      height: 33px;
    }
    .ad_cell_social{
      padding-left: 10px;
      font-size: 12px;
      width: 180px;
    }
    .ad_cell_button button{
      width: 144px;
      height: 24px;
      background: #ECECEC;
      border:1px solid #FFFFFF;
      border-radius:2px;
      font-size: 12px;
    }
    .ad_cell_tail{
      margin-top: 20px;
      height: 60px;
    }
    .ad_cell_tail table{
      font-size: 12px;
      width: 340px;
    }

    .ad_cell_tail table tr{
      display: block;
      padding-bottom: 8px;
    }

    .ad_cell_category{
    }

    .ad_cell_duration{
      width: 60px;
    }

    .ad_cell_heat{
      width: 60px;
    }

    .ad_cell_geo{
      width: 48px;
      margin-right: 12px;
    }

    .ad_cell_pkg{

    }

    .ad_cell_buttons{
      width: 300px;
      height: 24px;
    }

    .ad_cell_buttons input{
      background: #ECECEC;
      border:1px solid #FFFFFF;
      border-radius:2px;
      width: 96px;
      height: 24px;
      margin-left: 10px;
      margin-right: 10px;
    }

  /* ad cell css over */

  </style>
</html>